<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 70px; }
        .navbar-brand { font-weight: bold; }
        .tab-content { margin-top: 20px; }
        .table th, .table td { vertical-align: middle; }
        .modal-dialog { max-width: 600px; }
        select[multiple] { height: 150px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">School Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'students' %}active{% endif %}" href="{{ url_for('students') }}">Students</a>
                    </li>
                    {% if user_role != 'parent' %}
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'parents' %}active{% endif %}" href="{{ url_for('parents') }}">Parents</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'teachers' %}active{% endif %}" href="{{ url_for('teachers') }}">Teachers</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'classes' %}active{% endif %}" href="{{ url_for('classes') }}">Classes</a>
                    </li>
                    {% if user_role == 'admin' %}
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'classrooms' %}active{% endif %}" href="{{ url_for('classrooms') }}">Classrooms</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'users' %}active{% endif %}" href="{{ url_for('users') }}">Users</a>
                    </li>
                    {% endif %}
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'tuition' %}active{% endif %}" href="{{ url_for('tuition') }}">Tuition</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    <div class="container tab-content">
        {% if current_user.is_authenticated %}
        <div class="alert alert-info">
            Debug: User Role = {{ user_role|default('Not set') }}
        </div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if active_tab == 'students' %}
        <h2>Students</h2>
        {% if user_role in ['admin', 'teacher'] %}
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addStudentModal">Add Student</button>
        {% if user_role == 'admin' %}
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('import_from_csv') }}" class="d-inline">
            <input type="file" name="file" accept=".csv" class="d-none" id="csvFileInput" onchange="this.form.submit()">
            <button type="button" class="btn btn-secondary mb-3" onclick="document.getElementById('csvFileInput').click()">Import CSV</button>
        </form>
        {% endif %}
        {% endif %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Grade Level</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Parents</th>
                    <th>Medicines</th>
                    <th>Allergies</th>
                    <th>Medical Conditions</th>
                    <th>Comments</th>
                    {% if user_role in ['admin', 'teacher'] %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ student.first_name }}</td>
                    <td>{{ student.last_name }}</td>
                    <td>{{ student.grade_level }}</td>
                    <td>{{ student.email or '' }}</td>
                    <td>{{ student.phone | format_phone }}</td>
                    <td>
                        {% for parent in student.parents %}
                            {{ parent.last_name }}, {{ parent.first_name }}{% if not loop.last %}; {% endif %}
                        {% else %}
                            None
                        {% endfor %}
                    </td>
                    <td>{{ student.medicines or '' }}</td>
                    <td>{{ student.allergies or '' }}</td>
                    <td>{{ student.medical_conditions or '' }}</td>
                    <td>{{ student.comments or '' }}</td>
                    {% if user_role in ['admin', 'teacher'] %}
                    <td>
                        <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editStudentModal"
                                data-student-id="{{ student.student_id }}"
                                data-first-name="{{ student.first_name }}"
                                data-last-name="{{ student.last_name }}"
                                data-grade-level="{{ student.grade_level }}"
                                data-email="{{ student.email }}"
                                data-phone="{{ student.phone }}"
                                data-parent-ids="{{ student.parents | map(attribute='parent_id') | join(',') }}"
                                data-medicines="{{ student.medicines }}"
                                data-allergies="{{ student.allergies }}"
                                data-medical-conditions="{{ student.medical_conditions }}"
                                data-comments="{{ student.comments }}">Edit</button>
                        {% if user_role == 'admin' %}
                        <form method="POST" action="{{ url_for('delete_student', student_id=student.student_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this student?')">Delete</button>
                        </form>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr><td colspan="11">No students found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if active_tab == 'parents' %}
        <h2>Parents</h2>
        {% if user_role == 'admin' %}
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addParentModal">Add Parent</button>
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('import_from_csv') }}" class="d-inline">
            <input type="file" name="file" accept=".csv" class="d-none" id="csvFileInput" onchange="this.form.submit()">
            <button type="button" class="btn btn-secondary mb-3" onclick="document.getElementById('csvFileInput').click()">Import CSV</button>
        </form>
        {% endif %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Staff</th>
                    {% if user_role == 'admin' %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for parent in parents %}
                <tr>
                    <td>{{ parent.last_name }}, {{ parent.first_name }}</td>
                    <td>{{ parent.email or '' }}</td>
                    <td>{{ parent.phone | format_phone }}</td>
                    <td>{{ 'Yes' if parent.is_staff else 'No' }}</td>
                    {% if user_role == 'admin' %}
                    <td>
                        <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editParentModal"
                                data-parent-id="{{ parent.parent_id }}"
                                data-first-name="{{ parent.first_name }}"
                                data-last-name="{{ parent.last_name }}"
                                data-email="{{ parent.email }}"
                                data-phone="{{ parent.phone }}"
                                data-is-staff="{{ 'true' if parent.is_staff else 'false' }}">Edit</button>
                        <form method="POST" action="{{ url_for('delete_parent', parent_id=parent.parent_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this parent?')">Delete</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr><td colspan="5">No parents found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if active_tab == 'teachers' %}
        <h2>Teachers</h2>
        {% if user_role == 'admin' %}
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addTeacherModal">Add Teacher</button>
        {% endif %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    {% if user_role == 'admin' %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for teacher in teachers %}
                <tr>
                    <td>{{ teacher.first_name }}</td>
                    <td>{{ teacher.last_name }}</td>
                    <td>{{ teacher.email or '' }}</td>
                    <td>{{ teacher.phone | format_phone }}</td>
                    {% if user_role == 'admin' %}
                    <td>
                        <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editTeacherModal"
                                data-teacher-id="{{ teacher.teacher_id }}"
                                data-first-name="{{ teacher.first_name }}"
                                data-last-name="{{ teacher.last_name }}"
                                data-email="{{ teacher.email }}"
                                data-phone="{{ teacher.phone }}">Edit</button>
                        <form method="POST" action="{{ url_for('delete_teacher', teacher_id=teacher.teacher_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this teacher?')">Delete</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr><td colspan="5">No teachers found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if active_tab == 'tuition' %}
        <h2>Tuition</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Grade</th>
                    <th>Tuition Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for tuition in tuition %}
                <tr>
                    <td>{{ tuition.student_name }}</td>
                    <td>{{ tuition.grade }}</td>
                    <td>{{ tuition.amount }}</td>
                    <td>{{ tuition.status }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4">No tuition records found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if active_tab == 'classes' %}
        <h2>Classes</h2>
        {% if user_role == 'admin' %}
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addClassModal">Add Class</button>
        {% endif %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Days</th>
                    <th>Teacher</th>
                    <th>Grade Level</th>
                    <th>Max Size</th>
                    <th>Term</th>
                    <th>Schedule Block</th>
                    <th>Classroom</th>
                    <th>Students</th>
                    {% if user_role in ['admin', 'teacher'] %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for cls in classes %}
                <tr>
                    <td>{{ cls.name }}</td>
                    <td>{{ cls.days or '' }}</td>
                    <td>{{ cls.teachers.first_name + ' ' + cls.teachers.last_name if cls.teachers else 'None' }}</td>
                    <td>{{ cls.grade_level or '' }}</td>
                    <td>{{ cls.max_size or 'N/A' }}</td>
                    <td>{{ cls.term or '' }}</td>
                    <td>{{ cls.schedule_block or 'N/A' }}</td>
                    <td>{{ cls.classrooms.building_number + ' ' + cls.classrooms.room_number if cls.classrooms else 'None' }}</td>
                    <td>
                        {% for student in cls.students %}
                            {{ student.last_name }}, {{ student.first_name }} ({{ student.program_type or 'N/A' }}){% if not loop.last %}; {% endif %}
                        {% else %}
                            None
                        {% endfor %}
                    </td>
                    {% if user_role in ['admin', 'teacher'] %}
                    <td>
                        {% if user_role == 'admin' %}
                        <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editClassModal"
                                data-class-id="{{ cls.class_id }}"
                                data-name="{{ cls.name | e }}"
                                data-days="{{ cls.days_array | join(',') }}"
                                data-teacher-id="{{ cls.teacher_id or '' }}"
                                data-grade-level="{{ cls.grade_level or '' }}"
                                data-max-size="{{ cls.max_size or '' }}"
                                data-term="{{ cls.term or '' }}"
                                data-schedule-block="{{ cls.schedule_block or '' }}"
                                data-classroom-id="{{ cls.classroom_id or '' }}">Edit</button>
                        <form method="POST" action="{{ url_for('delete_class', class_id=cls.class_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this class?')">Delete</button>
                        </form>
                        {% endif %}
                        <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#assignStudentsModal"
                                data-class-id="{{ cls.class_id }}"
                                data-student-ids="{{ cls.students | map(attribute='student_id') | join(',') }}"
                                data-program-types="{{ cls.students | map(attribute='program_type') | join(',') }}">Assign Students</button>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr><td colspan="10">No classes found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if active_tab == 'classrooms' %}
        <h2>ClassBoards</h2>
        {% if user_role == 'admin' %}
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addClassroomModal">Add Classroom</button>
        {% endif %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Building Number</th>
                    <th>Room Number</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for classroom in classrooms %}
                <tr>
                    <td>{{ classroom.building_number }}</td>
                    <td>{{ classroom.room_number }}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editClassroomModal"
                                data-classroom-id="{{ classroom.classroom_id }}"
                                data-building-number="{{ classroom.building_number }}"
                                data-room-number="{{ classroom.room_number }}">Edit</button>
                        <form method="POST" action="{{ url_for('delete_classroom', classroom_id=classroom.classroom_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this classroom?')">Delete</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="3">No classrooms found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if active_tab == 'users' %}
        <h2>Users</h2>
        {% if user_role == 'admin' %}
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addUserModal">Add User</button>
        {% endif %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Parent</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.email }}</td>
                    <td>{{ user.role }}</td>
                    <td>{{ user.parent_name or 'N/A' }}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editUserModal"
                                data-user-id="{{ user.user_id }}"
                                data-email="{{ user.email }}"
                                data-role="{{ user.role }}"
                                data-parent-id="{{ user.parent_id or '' }}">Edit</button>
                        <form method="POST" action="{{ url_for('delete_user', user_id=user.user_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this user?')">Delete</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="4">No users found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>

    <!-- Modals -->
    {% if user_role in ['admin', 'teacher'] %}
    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStudentModalLabel">Add Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('add_student') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="grade_level" class="form-label">Grade Level</label>
                            <input type="text" class="form-control" id="grade_level" name="grade_level" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="phone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label for="parent_ids" class="form-label">Parents</label>
                            <select multiple class="form-control" id="parent_ids" name="parent_ids">
                                {% for parent in parents %}
                                <option value="{{ parent.parent_id }}">{{ parent.last_name }}, {{ parent.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="medicines" class="form-label">Medicines</label>
                            <input type="text" class="form-control" id="medicines" name="medicines">
                        </div>
                        <div class="mb-3">
                            <label for="allergies" class="form-label">Allergies</label>
                            <input type="text" class="form-control" id="allergies" name="allergies">
                        </div>
                        <div class="mb-3">
                            <label for="medical_conditions" class="form-label">Medical Conditions</label>
                            <input type="text" class="form-control" id="medical_conditions" name="medical_conditions">
                        </div>
                        <div class="mb-3">
                            <label for="comments" class="form-label">Comments</label>
                            <textarea class="form-control" id="comments" name="comments"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Student</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStudentModalLabel">Edit Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_student') }}">
                    <div class="modal-body">
                        <input type="hidden" id="edit_student_id" name="student_id">
                        <div class="mb-3">
                            <label for="edit_first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_grade_level" class="form-label">Grade Level</label>
                            <input type="text" class="form-control" id="edit_grade_level" name="grade_level" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit_email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="edit_phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="edit_phone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label for="edit_parent_ids" class="form-label">Parents</label>
                            <select multiple class="form-control" id="edit_parent_ids" name="parent_ids">
                                {% for parent in parents %}
                                <option value="{{ parent.parent_id }}">{{ parent.last_name }}, {{ parent.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_medicines" class="form-label">Medicines</label>
                            <input type="text" class="form-control" id="edit_medicines" name="medicines">
                        </div>
                        <div class="mb-3">
                            <label for="edit_allergies" class="form-label">Allergies</label>
                            <input type="text" class="form-control" id="edit_allergies" name="allergies">
                        </div>
                        <div class="mb-3">
                            <label for="edit_medical_conditions" class="form-label">Medical Conditions</label>
                            <input type="text" class="form-control" id="edit_medical_conditions" name="medical_conditions">
                        </div>
                        <div class="mb-3">
                            <label for="edit_comments" class="form-label">Comments</label>
                            <textarea class="form-control" id="edit_comments" name="comments"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Parent Modal -->
    {% if user_role == 'admin' %}
    <div class="modal fade" id="addParentModal" tabindex="-1" aria-labelledby="addParentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addParentModalLabel">Add Parent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('add_parent') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="phone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label for="is_staff" class="form-label">Is Staff</label>
                            <input type="checkbox" id="is_staff" name="is_staff">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Parent</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Parent Modal -->
    <div class="modal fade" id="editParentModal" tabindex="-1" aria-labelledby="editParentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editParentModalLabel">Edit Parent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_parent') }}">
                    <div class="modal-body">
                        <input type="hidden" id="edit_parent_id" name="parent_id">
                        <div class="mb-3">
                            <label for="edit_first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit_email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="edit_phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="edit_phone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label for="edit_is_staff" class="form-label">Is Staff</label>
                            <input type="checkbox" id="edit_is_staff" name="is_staff">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Teacher Modal -->
    <div class="modal fade" id="addTeacherModal" tabindex="-1" aria-labelledby="addTeacherModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTeacherModalLabel">Add Teacher</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('add_teacher') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="phone" name="phone">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Teacher</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Teacher Modal -->
    <div class="modal fade" id="editTeacherModal" tabindex="-1" aria-labelledby="editTeacherModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTeacherModalLabel">Edit Teacher</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_teacher') }}">
                    <div class="modal-body">
                        <input type="hidden" id="edit_teacher_id" name="teacher_id">
                        <div class="mb-3">
                            <label for="edit_first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit_email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="edit_phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="edit_phone" name="phone">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div class="modal fade" id="addClassModal" tabindex="-1" aria-labelledby="addClassModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addClassModalLabel">Add Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('add_class') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="days" class="form-label">Days</label>
                            <select multiple class="form-control" id="days" name="days">
                                <option value="0">Sunday</option>
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="teacher_id" class="form-label">Teacher</label>
                            <select class="form-control" id="teacher_id" name="teacher_id">
                                <option value="">None</option>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.teacher_id }}">{{ teacher.last_name }}, {{ teacher.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="grade_level" class="form-label">Grade Level</label>
                            <input type="text" class="form-control" id="grade_level" name="grade_level">
                        </div>
                        <div class="mb-3">
                            <label for="max_size" class="form-label">Max Size</label>
                            <input type="number" class="form-control" id="max_size" name="max_size">
                        </div>
                        <div class="mb-3">
                            <label for="term" class="form-label">Term</label>
                            <select class="form-control" id="term" name="term" required>
                                <option value="Semester 1">Semester 1</option>
                                <option value="Semester 2">Semester 2</option>
                                <option value="Both">Both</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="schedule_block" class="form-label">Schedule Block</label>
                            <input type="number" class="form-control" id="schedule_block" name="schedule_block">
                        </div>
                        <div class="mb-3">
                            <label for="classroom_id" class="form-label">Classroom</label>
                            <select class="form-control" id="classroom_id" name="classroom_id">
                                <option value="">None</option>
                                {% for classroom in classrooms %}
                                <option value="{{ classroom.classroom_id }}">{{ classroom.building_number }} {{ classroom.room_number }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Class</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Class Modal -->
    <div class="modal fade" id="editClassModal" tabindex="-1" aria-labelledby="editClassModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editClassModalLabel">Edit Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('edit_class') }}" method="POST">
                        <input type="hidden" name="class_id" id="class_id">
                        <div class="mb-3">
                            <label for="name" class="form-label">Class Name</label>
                            <input type="text" class="form-control" id="name" name="name">
                        </div>
                        <div class="mb-3">
                            <label for="grade_level" class="form-label">Grade Level</label>
                            <input type="text" class="form-control" id="grade_level" name="grade_level" placeholder="e.g., 1st, 2nd">
                        </div>
                        <div class="mb-3">
                            <label for="term" class="form-label">Term</label>
                            <select class="form-select" id="term" name="term">
                                <option value="Both">Both</option>
                                <option value="Semester 1">Semester 1</option>
                                <option value="Semester 2">Semester 2</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="schedule_block" class="form-label">Schedule Block</label>
                            <select class="form-select" id="schedule_block" name="schedule_block">
                                <option value="">Select Block</option>
                                <option value="1">Block 1</option>
                                <option value="2">Block 2</option>
                                <option value="3">Block 3</option>
                                <option value="4">Block 4</option>
                                <option value="5">Block 5</option>
                                <option value="6">Block 6</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="max_size" class="form-label">Max Size</label>
                            <input type="number" class="form-control" id="max_size" name="max_size">
                        </div>
                        <!-- Add other fields as needed (e.g., days, teacher_id, classroom_id) -->
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    

    <!-- Assign Students Modal (unchanged from previous update) -->
    <div class="modal fade" id="assignStudentsModal" tabindex="-1" aria-labelledby="assignStudentsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignStudentsModalLabel">Assign Students to Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('assign_students_to_class') }}">
                    <div class="modal-body">
                        <input type="hidden" name="class_id" id="assignClassId">
                        <div class="mb-3">
                            <label for="studentSelect" class="form-label">Select Students</label>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>Student</th>
                                        <th>Program Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in students %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="student_ids" value="{{ student.student_id }}" class="student-checkbox">
                                        </td>
                                        <td>{{ student.last_name }}, {{ student.first_name }}</td>
                                        <td>
                                            <select name="program_types" class="form-select program-type-select">
                                                <option value="">Select Program Type</option>
                                                <option value="morning">Morning</option>
                                                <option value="afternoon">Afternoon</option>
                                                <option value="full">Full</option>
                                                <option value="enrichment">Enrichment</option>
                                                <option value="academic">Academic</option>
                                            </select>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Assign Students</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Classroom Modal -->
    <div class="modal fade" id="addClassroomModal" tabindex="-1" aria-labelledby="addClassroomModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addClassroomModalLabel">Add Classroom</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('add_classroom') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="building_number" class="form-label">Building Number</muir>
                            <input type="text" class="form-control" id="building_number" name="building_number" required>
                        </div>
                        <div class="mb-3">
                            <label for="room_number" class="form-label">Room Number</label>
                            <input type="text" class="form-control" id="room_number" name="room_number" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Classroom</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Classroom Modal -->
    <div class="modal fade" id="editClassroomModal" tabindex="-1" aria-labelledby="editClassroomModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editClassroomModalLabel">Edit Classroom</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_classroom') }}">
                    <div class="modal-body">
                        <input type="hidden" id="edit_classroom_id" name="classroom_id">
                        <div class="mb-3">
                            <label for="edit_building_number" class="form-label">Building Number</label>
                            <input type="text" class="form-control" id="edit_building_number" name="building_number" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_room_number" class="form-label">Room Number</label>
                            <input type="text" class="form-control" id="edit_room_number" name="room_number" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('add_user') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="role" class="form-label">Role</label>
                            <select class="form-control" id="role" name="role" required>
                                <option value="admin">Admin</option>
                                <option value="teacher">Teacher</option>
                                <option value="parent">Parent</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="parent_id" class="form-label">Parent (Required for Parent Role)</label>
                            <select class="form-control" id="parent_id" name="parent_id">
                                <option value="">None</option>
                                {% for parent in parents %}
                                <option value="{{ parent.parent_id }}">{{ parent.last_name }}, {{ parent.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_user') }}">
                    <div class="modal-body">
                        <input type="hidden" id="edit_user_id" name="user_id">
                        <div class="mb-3">
                            <label for="edit_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit_email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_password" class="form-label">Password (Leave blank to keep unchanged)</label>
                            <input type="password" class="form-control" id="edit_password" name="password">
                        </div>
                        <div class="mb-3">
                            <label for="edit_role" class="form-label">Role</label>
                            <select class="form-control" id="edit_role" name="role" required>
                                <option value="admin">Admin</option>
                                <option value="teacher">Teacher</option>
                                <option value="parent">Parent</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_parent_id" class="form-label">Parent (Required for Parent Role)</label>
                            <select class="form-control" id="edit_parent_id" name="parent_id">
                                <option value="">None</option>
                                {% for parent in parents %}
                                <option value="{{ parent.parent_id }}">{{ parent.last_name }}, {{ parent.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Edit Student Modal
        document.getElementById('editStudentModal')?.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var studentId = button.getAttribute('data-student-id');
            var firstName = button.getAttribute('data-first-name');
            var lastName = button.getAttribute('data-last-name');
            var gradeLevel = button.getAttribute('data-grade-level');
            var email = button.getAttribute('data-email');
            var phone = button.getAttribute('data-phone');
            var parentIds = button.getAttribute('data-parent-ids');
            var medicines = button.getAttribute('data-medicines');
            var allergies = button.getAttribute('data-allergies');
            var medicalConditions = button.getAttribute('data-medical-conditions');
            var comments = button.getAttribute('data-comments');

            var modal = this;
            modal.querySelector('#edit_student_id').value = studentId;
            modal.querySelector('#edit_first_name').value = firstName;
            modal.querySelector('#edit_last_name').value = lastName;
            modal.querySelector('#edit_grade_level').value = gradeLevel;
            modal.querySelector('#edit_email').value = email || '';
            modal.querySelector('#edit_phone').value = phone || '';
            modal.querySelector('#edit_medicines').value = medicines || '';
            modal.querySelector('#edit_allergies').value = allergies || '';
            modal.querySelector('#edit_medical_conditions').value = medicalConditions || '';
            modal.querySelector('#edit_comments').value = comments || '';

            var select = modal.querySelector('#edit_parent_ids');
            var parentIdArray = parentIds ? parentIds.split(',') : [];
            for (var i = 0; i < select.options.length; i++) {
                select.options[i].selected = parentIdArray.includes(select.options[i].value);
            }
        });

        // Edit Parent Modal
        document.getElementById('editParentModal')?.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var parentId = button.getAttribute('data-parent-id');
            var firstName = button.getAttribute('data-first-name');
            var lastName = button.getAttribute('data-last-name');
            var email = button.getAttribute('data-email');
            var phone = button.getAttribute('data-phone');
            var isStaff = button.getAttribute('data-is-staff') === 'true';

            var modal = this;
            modal.querySelector('#edit_parent_id').value = parentId;
            modal.querySelector('#edit_first_name').value = firstName;
            modal.querySelector('#edit_last_name').value = lastName;
            modal.querySelector('#edit_email').value = email || '';
            modal.querySelector('#edit_phone').value = phone || '';
            modal.querySelector('#edit_is_staff').checked = isStaff;
        });

        // Edit Teacher Modal
        document.getElementById('editTeacherModal')?.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var teacherId = button.getAttribute('data-teacher-id');
            var firstName = button.getAttribute('data-first-name');
            var lastName = button.getAttribute('data-last-name');
            var email = button.getAttribute('data-email');
            var phone = button.getAttribute('data-phone');

            var modal = this;
            modal.querySelector('#edit_teacher_id').value = teacherId;
            modal.querySelector('#edit_first_name').value = firstName;
            modal.querySelector('#edit_last_name').value = lastName;
            modal.querySelector('#edit_email').value = email || '';
            modal.querySelector('#edit_phone').value = phone || '';
        });

        // Edit Class Modal
        document.getElementById('editClassModal')?.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var classId = button.getAttribute('data-class-id');
            var name = button.getAttribute('data-name');
            var days = button.getAttribute('data-days');
            var teacherId = button.getAttribute('data-teacher-id');
            var gradeLevel = button.getAttribute('data-grade-level');
            var maxSize = button.getAttribute('data-max-size');
            var term = button.getAttribute('data-term');
            var scheduleBlock = button.getAttribute('data-schedule-block');
            var classroomId = button.getAttribute('data-classroom-id');

            var modal = this;
            modal.querySelector('#edit_class_id').value = classId;
            modal.querySelector('#edit_name').value = name;
            modal.querySelector('#edit-grade_level').value = gradeLevel;
            modal.querySelector('#edit-max_size').value = maxSize || '';
            modal.querySelector('#edit-term').value = term;
            modal.querySelector('#edit-schedule_block').value = scheduleBlock || '';

            // Reset all checkboxes
            modal.querySelector('#edit_sunday').checked = false;
            modal.querySelector('#edit_monday').checked = false;
            modal.querySelector('#edit_tuesday').checked = false;
            modal.querySelector('#edit_wednesday').checked = false;
            modal.querySelector('#edit_thursday').checked = false;
            modal.querySelector('#edit_friday').checked = false;
            modal.querySelector('#edit_saturday').checked = false;

            // Check the days
            var dayArray = days ? days.split(',') : [];
            if (dayArray.includes('0')) modal.querySelector('#edit_sunday').checked = true;
            if (dayArray.includes('1')) modal.querySelector('#edit_monday').checked = true;
            if (dayArray.includes('2')) modal.querySelector('#edit_tuesday').checked = true;
            if (dayArray.includes('3')) modal.querySelector('#edit_wednesday').checked = true;
            if (dayArray.includes('4')) modal.querySelector('#edit_thursday').checked = true;
            if (dayArray.includes('5')) modal.querySelector('#edit_friday').checked = true;
            if (dayArray.includes('6')) modal.querySelector('#edit_saturday').checked = true;

            var teacherSelect = modal.querySelector('#edit_teacher_id');
            for (var i = 0; i < teacherSelect.options.length; i++) {
                teacherSelect.options[i].selected = teacherSelect.options[i].value === teacherId;
            }

            var classroomSelect = modal.querySelector('#edit-classroom_id');
            for (var i = 0; i < classroomSelect.options.length; i++) {
                classroomSelect.options[i].selected = classroomSelect.options[i].value === classroomId;
            }
        });

        // Assign Students Modal
        document.getElementById('assignStudentsModal')?.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var classId = button.getAttribute('data-class-id');
            var studentIds = button.getAttribute('data-student-ids');

            var modal = this;
            modal.querySelector('#assign_class_id').value = classId;

            var select = modal.querySelector('#student_ids');
            var studentIdArray = studentIds ? studentIds.split(',') : [];
            for (var i = 0; i < select.options.length; i++) {
                select.options[i].selected = studentIdArray.includes(select.options[i].value);
            }
        });

        // Edit Classroom Modal
        document.getElementById('editClassroomModal')?.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var classroomId = button.getAttribute('data-classroom-id');
            var buildingNumber = button.getAttribute('data-building-number');
            var roomNumber = button.getAttribute('data-room-number');

            var modal = this;
            modal.querySelector('#edit_classroom_id').value = classroomId;
            modal.querySelector('#edit_building_number').value = buildingNumber;
            modal.querySelector('#edit_room_number').value = roomNumber;
        });

        // Edit User Modal
        document.getElementById('editUserModal')?.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var userId = button.getAttribute('data-user-id');
            var email = button.getAttribute('data-email');
            var role = button.getAttribute('data-role');
            var parentId = button.getAttribute('data-parent-id');

            var modal = this;
            modal.querySelector('#edit_user_id').value = userId;
            modal.querySelector('#edit_email').value = email;
            modal.querySelector('#edit_role').value = role;

            var select = modal.querySelector('#edit_parent_id');
            for (var i = 0; i < select.options.length; i++) {
                select.options[i].selected = select.options[i].value === parentId;
            }
        });
        document.addEventListener('DOMContentLoaded', function () {
            // Handle Assign Students Modal
            var assignStudentsModal = document.getElementById('assignStudentsModal');
            assignStudentsModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var classId = button.getAttribute('data-class-id');
                var studentIds = button.getAttribute('data-student-ids').split(',');
                var programTypes = button.getAttribute('data-program-types').split(',');

                var modal = assignStudentsModal;
                modal.querySelector('#assignClassId').value = classId;

                // Reset all checkboxes and program types
                var checkboxes = modal.querySelectorAll('.student-checkbox');
                var programSelects = modal.querySelectorAll('.program-type-select');
                checkboxes.forEach(cb => cb.checked = false);
                programSelects.forEach(sel => sel.value = '');

                // Set checked students and their program types
                checkboxes.forEach((cb, index) => {
                    if (studentIds.includes(cb.value)) {
                        cb.checked = true;
                        programSelects[index].value = programTypes[index] || '';
                    }
                });
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('editClassModal');
            modal.addEventListener('show.bs.modal', async (event) => {
                const button = event.relatedTarget; // Button that triggered the modal
                const classId = button.dataset.classId; // Assumes data-class-id attribute
                
                // Fetch class data
                const response = await fetch(`/api/class/${classId}`);
                const classData = await response.json();
                
                // Populate form
                document.getElementById('class_id').value = classData.class_id;
                document.getElementById('name').value = classData.name || '';
                document.getElementById('grade_level').value = classData.grade_level ? classData.grade_level.join(', ') : '';
                document.getElementById('term').value = classData.term || 'Both';
                document.getElementById('schedule_block').value = classData.schedule_block ? classData.schedule_block[0] : '';
                document.getElementById('max_size').value = classData.max_size || '';
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Handle Add Class Modal
            var addClassModal = document.getElementById('addClassModal');
            addClassModal.addEventListener('show.bs.modal', function () {
                // Reset form
                var form = addClassModal.querySelector('form');
                form.reset();
            });

            // Handle Edit Class Modal
            var editClassModal = document.getElementById('editClassModal');
            editClassModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var classId = button.getAttribute('data-class-id');
                var name = button.getAttribute('data-name');
                var days = button.getAttribute('data-days').split(',');
                var teacherId = button.getAttribute('data-teacher-id');
                var gradeLevel = button.getAttribute('data-grade-level');
                var maxSize = button.getAttribute('data-max-size');
                var term = button.getAttribute('data-term');
                var scheduleBlock = button.getAttribute('data-schedule-block');
                var classroomId = button.getAttribute('data-classroom-id');

                var modal = editClassModal;
                modal.querySelector('#editClassId').value = classId;
                modal.querySelector('#editName').value = name;
                modal.querySelector('#editTeacherId').value = teacherId || '';
                modal.querySelector('#editGradeLevel').value = gradeLevel || '';
                modal.querySelector('#editMaxSize').value = maxSize || '';
                modal.querySelector('#editTerm').value = term || '';
                modal.querySelector('#editScheduleBlock').value = scheduleBlock || '';
                modal.querySelector('#editClassroomId').value = classroomId || '';

                var dayOptions = modal.querySelector('#editDays').options;
                for (var i = 0; i < dayOptions.length; i++) {
                    dayOptions[i].selected = days.includes(dayOptions[i].value);
                }
            });

            // Handle Assign Students Modal
            var assignStudentsModal = document.getElementById('assignStudentsModal');
            assignStudentsModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var classId = button.getAttribute('data-class-id');
                var studentIds = button.getAttribute('data-student-ids').split(',');
                var programTypes = button.getAttribute('data-program-types').split(',');

                var modal = assignStudentsModal;
                modal.querySelector('#assignClassId').value = classId;

                // Reset all checkboxes and program types
                var checkboxes = modal.querySelectorAll('.student-checkbox');
                var programSelects = modal.querySelectorAll('.program-type-select');
                checkboxes.forEach(cb => cb.checked = false);
                programSelects.forEach(sel => sel.value = '');

                // Set checked students and their program types
                checkboxes.forEach((cb, index) => {
                    if (studentIds.includes(cb.value)) {
                        cb.checked = true;
                        programSelects[index].value = programTypes[index] || '';
                    }
                });
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93816836ceb132f5',t:'MTc0NTk1NzA1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>