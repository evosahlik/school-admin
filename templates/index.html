<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 70px; }
        .navbar-brand { font-weight: bold; }
        .tab-content { margin-top: 20px; }
        .table th, .table td { vertical-align: middle; }
        .modal-dialog { max-width: 600px; }
        select[multiple] { height: 150px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">School Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'students' %}active{% endif %}" href="{{ url_for('students') }}">Students</a>
                    </li>
                    {% if user_role != 'parent' %}
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'parents' %}active{% endif %}" href="{{ url_for('parents') }}">Parents</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'teachers' %}active{% endif %}" href="{{ url_for('teachers') }}">Teachers</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'classes' %}active{% endif %}" href="{{ url_for('classes') }}">Classes</a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link {% if active_tab == 'tuition' %}active{% endif %}" href="{{ url_for('tuition') }}">Tuition</a>
                    </li>
                </ul>
                <!-- Existing navbar-nav ms-auto for user info and logout -->
            </div>
        </div>
    </nav>
    <div class="container tab-content">
        {% if current_user.is_authenticated %}
        <div class="alert alert-info">
            Debug: User Role = {{ user_role|default('Not set') }}
        </div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if active_tab == 'students' %}
        <h2>Students</h2>
        {% if user_role in ['admin', 'teacher'] %}
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addStudentModal">Add Student</button>
        {% if user_role == 'admin' %}
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('import_from_csv') }}" class="d-inline">
            <input type="file" name="file" accept=".csv" class="d-none" id="csvFileInput" onchange="this.form.submit()">
            <button type="button" class="btn btn-secondary mb-3" onclick="document.getElementById('csvFileInput').click()">Import CSV</button>
        </form>
        {% endif %}
        {% endif %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Grade Level</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Parents</th>
                    <th>Medicines</th>
                    <th>Allergies</th>
                    <th>Medical Conditions</th>
                    <th>Comments</th>
                    {% if user_role in ['admin', 'teacher'] %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ student.first_name }}</td>
                    <td>{{ student.last_name }}</td>
                    <td>{{ student.grade_level }}</td>
                    <td>{{ student.email or '' }}</td>
                    <td>{{ student.phone | format_phone }}</td>
                    <td>
                        {% for parent in student.parents %}
                            {{ parent.last_name }}, {{ parent.first_name }}{% if not loop.last %}; {% endif %}
                        {% else %}
                            None
                        {% endfor %}
                    </td>
                    <td>{{ student.medicines or '' }}</td>
                    <td>{{ student.allergies or '' }}</td>
                    <td>{{ student.medical_conditions or '' }}</td>
                    <td>{{ student.comments or '' }}</td>
                    {% if user_role in ['admin', 'teacher'] %}
                    <td>
                        <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editStudentModal"
                                data-student-id="{{ student.student_id }}"
                                data-first-name="{{ student.first_name }}"
                                data-last-name="{{ student.last_name }}"
                                data-grade-level="{{ student.grade_level }}"
                                data-email="{{ student.email }}"
                                data-phone="{{ student.phone }}"
                                data-parent-ids="{{ student.parents | map(attribute='parent_id') | join(',') }}"
                                data-medicines="{{ student.medicines }}"
                                data-allergies="{{ student.allergies }}"
                                data-medical-conditions="{{ student.medical_conditions }}"
                                data-comments="{{ student.comments }}">Edit</button>
                        {% if user_role == 'admin' %}
                        <form method="POST" action="{{ url_for('delete_student', student_id=student.student_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this student?')">Delete</button>
                        </form>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr><td colspan="11">No students found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if active_tab == 'parents' %}
        <h2>Parents</h2>
        {% if user_role == 'admin' %}
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addParentModal">Add Parent</button>
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('import_from_csv') }}" class="d-inline">
            <input type="file" name="file" accept=".csv" class="d-none" id="csvFileInput" onchange="this.form.submit()">
            <button type="button" class="btn btn-secondary mb-3" onclick="document.getElementById('csvFileInput').click()">Import CSV</button>
        </form>
        {% endif %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Staff</th>
                    {% if user_role == 'admin' %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for parent in parents %}
                <tr>
                    <td>{{ parent.last_name }}, {{ parent.first_name }}</td>
                    <td>{{ parent.email or '' }}</td>
                    <td>{{ parent.phone | format_phone }}</td>
                    <td>{{ 'Yes' if parent.is_staff else 'No' }}</td>
                    {% if user_role == 'admin' %}
                    <td>
                        <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editParentModal"
                                data-parent-id="{{ parent.parent_id }}"
                                data-first-name="{{ parent.first_name }}"
                                data-last-name="{{ parent.last_name }}"
                                data-email="{{ parent.email }}"
                                data-phone="{{ parent.phone }}"
                                data-is-staff="{{ parent.is_staff }}">Edit</button>
                        <form method="POST" action="{{ url_for('delete_parent', parent_id=parent.parent_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this parent?')">Delete</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr><td colspan="5">No parents found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if active_tab == 'teachers' %}
        <h2>Teachers</h2>
        {% if user_role == 'admin' %}
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addTeacherModal">Add Teacher</button>
        {% endif %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    {% if user_role == 'admin' %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for teacher in teachers %}
                <tr>
                    <td>{{ teacher.first_name }}</td>
                    <td>{{ teacher.last_name }}</td>
                    <td>{{ teacher.email or '' }}</td>
                    <td>{{ teacher.phone | format_phone }}</td>
                    {% if user_role == 'admin' %}
                    <td>
                        <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editTeacherModal"
                                data-teacher-id="{{ teacher.teacher_id }}"
                                data-first-name="{{ teacher.first_name }}"
                                data-last-name="{{ teacher.last_name }}"
                                data-email="{{ teacher.email }}"
                                data-phone="{{ teacher.phone }}">Edit</button>
                        <form method="POST" action="{{ url_for('delete_teacher', teacher_id=teacher.teacher_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this teacher?')">Delete</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr><td colspan="5">No teachers found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if active_tab == 'tuition' %}
        <h2>Tuition</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Grade</th>
                    <th>Tuition Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for tuition in tuition %}
                <tr>
                    <td>{{ tuition.student_name }}</td>
                    <td>{{ tuition.grade }}</td>
                    <td>{{ tuition.amount }}</td>
                    <td>{{ tuition.status }}</td>
                </tr>
                {% else %}
                <tr><td colspan="4">No tuition records found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        {% if active_tab == 'classes' %}
        <h2>Classes</h2>
        {% if user_role == 'admin' %}
        <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addClassModal">Add Class</button>
        {% endif %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Days</th>
                    <th>Teacher</th>
                    <th>Students</th>
                    {% if user_role in ['admin', 'teacher'] %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for cls in classes %}
                <tr>
                    <td>{{ cls.name }}</td>
                    <td>{{ cls.days }}</td>
                    <td>{{ cls.teachers.first_name }} {{ cls.teachers.last_name }}</td>
                    <td>
                        {% for student in cls.students %}
                            {{ student.last_name }}, {{ student.first_name }}{% if not loop.last %}; {% endif %}
                        {% else %}
                            None
                        {% endfor %}
                    </td>
                    {% if user_role in ['admin', 'teacher'] %}
                    <td>
                        {% if user_role == 'admin' %}
                        <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editClassModal"
                                data-class-id="{{ cls.class_id }}"
                                data-name="{{ cls.name }}"
                                data-days="{{ cls.days }}"
                                data-teacher-id="{{ cls.teacher_id }}">Edit</button>
                        <form method="POST" action="{{ url_for('delete_class', class_id=cls.class_id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this class?')">Delete</button>
                        </form>
                        {% endif %}
                        <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#assignStudentsModal"
                                data-class-id="{{ cls.class_id }}"
                                data-student-ids="{{ cls.students | map(attribute='student_id') | join(',') }}">Assign Students</button>
                    </td>
                    {% endif %}
                </tr>
                {% else %}
                <tr><td colspan="5">No classes found</td></tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>

    {% if user_role in ['admin', 'teacher'] %}
    <div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStudentModalLabel">Add Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('add_student') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="grade_level" class="form-label">Grade Level</label>
                            <input type="text" class="form-control" id="grade_level" name="grade_level" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="phone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label for="parent_ids" class="form-label">Parents</label>
                            <select multiple class="form-control" id="parent_ids" name="parent_ids">
                                {% for parent in parents %}
                                <option value="{{ parent.parent_id }}">{{ parent.last_name }}, {{ parent.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="medicines" class="form-label">Medicines</label>
                            <input type="text" class="form-control" id="medicines" name="medicines">
                        </div>
                        <div class="mb-3">
                            <label for="allergies" class="form-label">Allergies</label>
                            <input type="text" class="form-control" id="allergies" name="allergies">
                        </div>
                        <div class="mb-3">
                            <label for="medical_conditions" class="form-label">Medical Conditions</label>
                            <input type="text" class="form-control" id="medical_conditions" name="medical_conditions">
                        </div>
                        <div class="mb-3">
                            <label for="comments" class="form-label">Comments</label>
                            <textarea class="form-control" id="comments" name="comments"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Student</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStudentModalLabel">Edit Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_student') }}">
                    <div class="modal-body">
                        <input type="hidden" id="edit_student_id" name="student_id">
                        <div class="mb-3">
                            <label for="edit_first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_grade_level" class="form-label">Grade Level</label>
                            <input type="text" class="form-control" id="edit_grade_level" name="grade_level" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit_email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="edit_phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="edit_phone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label for="edit_parent_ids" class="form-label">Parents</label>
                            <select multiple class="form-control" id="edit_parent_ids" name="parent_ids">
                                {% for parent in parents %}
                                <option value="{{ parent.parent_id }}">{{ parent.last_name }}, {{ parent.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_medicines" class="form-label">Medicines</label>
                            <input type="text" class="form-control" id="edit_medicines" name="medicines">
                        </div>
                        <div class="mb-3">
                            <label for="edit_allergies" class="form-label">Allergies</label>
                            <input type="text" class="form-control" id="edit_allergies" name="allergies">
                        </div>
                        <div class="mb-3">
                            <label for="edit_medical_conditions" class="form-label">Medical Conditions</label>
                            <input type="text" class="form-control" id="edit_medical_conditions" name="medical_conditions">
                        </div>
                        <div class="mb-3">
                            <label for="edit_comments" class="form-label">Comments</label>
                            <textarea class="form-control" id="edit_comments" name="comments"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    {% if user_role == 'admin' %}
    <div class="modal fade" id="addParentModal" tabindex="-1" aria-labelledby="addParentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addParentModalLabel">Add Parent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('add_parent') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="phone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label for="is_staff" class="form-label">Is Staff?</label>
                            <input type="checkbox" id="is_staff" name="is_staff">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Parent</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editParentModal" tabindex="-1" aria-labelledby="editParentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editParentModalLabel">Edit Parent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_parent') }}">
                    <div class="modal-body">
                        <input type="hidden" id="edit_parent_id" name="parent_id">
                        <div class="mb-3">
                            <label for="edit_first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit_email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="edit_phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="edit_phone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label for="edit_is_staff" class="form-label">Is Staff?</label>
                            <input type="checkbox" id="edit_is_staff" name="is_staff">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addTeacherModal" tabindex="-1" aria-labelledby="addTeacherModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTeacherModalLabel">Add Teacher</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('add_teacher') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="phone" name="phone">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Teacher</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editTeacherModal" tabindex="-1" aria-labelledby="editTeacherModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTeacherModalLabel">Edit Teacher</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_teacher') }}">
                    <div class="modal-body">
                        <input type="hidden" id="edit_teacher_id" name="teacher_id">
                        <div class="mb-3">
                            <label for="edit_first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit_email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="edit_phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="edit_phone" name="phone">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    {% if user_role in ['admin', 'teacher'] %}
    <div class="modal fade" id="addClassModal" tabindex="-1" aria-labelledby="addClassModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addClassModalLabel">Add Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('add_class') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="days" class="form-label">Days (e.g., Monday,Wednesday)</label>
                            <input type="text" class="form-control" id="days" name="days" required>
                        </div>
                        <div class="mb-3">
                            <label for="teacher_id" class="form-label">Teacher</label>
                            <select class="form-control" id="teacher_id" name="teacher_id">
                                <option value="">None</option>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.teacher_id }}">{{ teacher.last_name }}, {{ teacher.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Class</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editClassModal" tabindex="-1" aria-labelledby="editClassModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editClassModalLabel">Edit Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_class') }}">
                    <div class="modal-body">
                        <input type="hidden" id="edit_class_id" name="class_id">
                        <div class="mb-3">
                            <label for="edit_name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="edit_name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_days" class="form-label">Days</label>
                            <input type="text" class="form-control" id="edit_days" name="days" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_teacher_id" class="form-label">Teacher</label>
                            <select class="form-control" id="edit_teacher_id" name="teacher_id">
                                <option value="">None</option>
                                {% for teacher in teachers %}
                                <option value="{{ teacher.teacher_id }}">{{ teacher.last_name }}, {{ teacher.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignStudentsModal" tabindex="-1" aria-labelledby="assignStudentsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignStudentsModalLabel">Assign Students to Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('assign_students_to_class') }}">
                    <div class="modal-body">
                        <input type="hidden" id="assign_class_id" name="class_id">
                        <div class="mb-3">
                            <label for="student_ids" class="form-label">Students</label>
                            <select multiple class="form-control" id="student_ids" name="student_ids">
                                {% for student in students %}
                                <option value="{{ student.student_id }}">{{ student.last_name }}, {{ student.first_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Assign Students</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const editStudentModal = document.getElementById('editStudentModal');
        if (editStudentModal) {
            editStudentModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const modal = this;
                modal.querySelector('#edit_student_id').value = button.getAttribute('data-student-id');
                modal.querySelector('#edit_first_name').value = button.getAttribute('data-first-name');
                modal.querySelector('#edit_last_name').value = button.getAttribute('data-last-name');
                modal.querySelector('#edit_grade_level').value = button.getAttribute('data-grade-level');
                modal.querySelector('#edit_email').value = button.getAttribute('data-email') || '';
                modal.querySelector('#edit_phone').value = button.getAttribute('data-phone') || '';
                modal.querySelector('#edit_medicines').value = button.getAttribute('data-medicines') || '';
                modal.querySelector('#edit_allergies').value = button.getAttribute('data-allergies') || '';
                modal.querySelector('#edit_medical_conditions').value = button.getAttribute('data-medical-conditions') || '';
                modal.querySelector('#edit_comments').value = button.getAttribute('data-comments') || '';
                
                const parentIds = button.getAttribute('data-parent-ids') ? button.getAttribute('data-parent-ids').split(',') : [];
                const select = modal.querySelector('#edit_parent_ids');
                Array.from(select.options).forEach(option => {
                    option.selected = parentIds.includes(option.value);
                });
            });
        }

        const editParentModal = document.getElementById('editParentModal');
        if (editParentModal) {
            editParentModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const modal = this;
                modal.querySelector('#edit_parent_id').value = button.getAttribute('data-parent-id');
                modal.querySelector('#edit_first_name').value = button.getAttribute('data-first-name');
                modal.querySelector('#edit_last_name').value = button.getAttribute('data-last-name');
                modal.querySelector('#edit_email').value = button.getAttribute('data-email') || '';
                modal.querySelector('#edit_phone').value = button.getAttribute('data-phone') || '';
                modal.querySelector('#edit_is_staff').checked = button.getAttribute('data-is-staff') === 'True';
            });
        }

        const editTeacherModal = document.getElementById('editTeacherModal');
        if (editTeacherModal) {
            editTeacherModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const modal = this;
                modal.querySelector('#edit_teacher_id').value = button.getAttribute('data-teacher-id');
                modal.querySelector('#edit_first_name').value = button.getAttribute('data-first-name');
                modal.querySelector('#edit_last_name').value = button.getAttribute('data-last-name');
                modal.querySelector('#edit_email').value = button.getAttribute('data-email') || '';
                modal.querySelector('#edit_phone').value = button.getAttribute('data-phone') || '';
            });
        }

        const editClassModal = document.getElementById('editClassModal');
        if (editClassModal) {
            editClassModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const modal = this;
                modal.querySelector('#edit_class_id').value = button.getAttribute('data-class-id');
                modal.querySelector('#edit_name').value = button.getAttribute('data-name');
                modal.querySelector('#edit_days').value = button.getAttribute('data-days');
                const teacherId = button.getAttribute('data-teacher-id') || '';
                modal.querySelector('#edit_teacher_id').value = teacherId;
            });
        }

        const assignStudentsModal = document.getElementById('assignStudentsModal');
        if (assignStudentsModal) {
            assignStudentsModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const modal = this;
                modal.querySelector('#assign_class_id').value = button.getAttribute('data-class-id');
                const studentIds = button.getAttribute('data-student-ids') ? button.getAttribute('data-student-ids').split(',') : [];
                const select = modal.querySelector('#student_ids');
                Array.from(select.options).forEach(option => {
                    option.selected = studentIds.includes(option.value);
                });
            });
        }
    </script>
</body>
</html>